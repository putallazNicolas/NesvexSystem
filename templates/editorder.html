{% extends "layout.html" %}

{% block title %}
    Editar Pedido
{% endblock %}

{% block main %}
  <div class="container">
    <h1 class="mb-4">Editar Pedido</h1>
    <form method="POST" action="/orders/edit/{{ order.id }}" style="max-width: 700px;">
      <!-- Selección de cliente -->
      <div class="form-group">
        <label for="cliente">Cliente</label>
        <select class="form-control" id="cliente" name="cliente">
          {% for cliente in clientes %}
            <option value="{{ cliente.id }}" {% if cliente.id == order.cliente_id %}selected{% endif %}>{{ cliente.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Selector de fecha estimada de entrega -->
      <div class="form-group">
        <label for="fechaEntrega">Fecha Estimada de Entrega</label>
        <input type="date" class="form-control" id="fechaEntrega" name="fechaEntrega" value="{{ order.fecha_de_entrega }}">
      </div>
      <!-- Sección de artículos -->
      <div class="form-group">
        <label>Artículos</label>
        <div id="articulos-container">
          {% for article in order_articles %}
            <div class="article-row row mb-2">
              <div class="col-md-4">
                <select class="form-control articulo-select" name="articulos[{{ loop.index0 }}][id]">
                  {% for articulo in articulos %}
                    <option value="{{ articulo.id }}" {% if articulo.id == article.articulo_id %}selected{% endif %} data-costo="{{ articulo.costo }}" data-valor="{{ articulo.valor }}">
                      {{ articulo.descripcion }} - Costo: {{ articulo.costo }} - Precio: {{ articulo.valor }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col">
                <input type="number" min="1" class="form-control cantidad-input" name="articulos[{{ loop.index0 }}][cantidad]" value="{{ article.cantidad }}">
              </div>
              <div class="col-md">
                <input type="text" class="form-control costo-total-articulo" name="articulos[{{ loop.index0 }}][costo_total]" readonly value="{{ article.costo_total }}">
              </div>
              <div class="col-md-1">
                <button type="button" class="btn btn-danger remove-article">X</button>
              </div>
            </div>
          {% endfor %}
        </div>
        <button type="button" class="btn btn-primary mt-2" id="add-article">Agregar Artículo</button>
      </div>
      <!-- Totales del Pedido -->
      <div class="form-group">
        <label for="totalCostoPedido">Costo Total del Pedido</label>
        <input type="text" class="form-control" id="totalCostoPedido" name="totalCostoPedido" readonly value="0.00">
      </div>
      <div class="form-group">
        <label for="totalPrecioPedido">Precio Total del Pedido</label>
        <input type="text" class="form-control" id="totalPrecioPedido" name="totalPrecioPedido" value="{{ order.valor }}">
      </div>

      <button type="submit" class="btn btn-success">Actualizar Pedido</button>
    </form>
  </div>

  <!-- jQuery y Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    // Variable para el índice de los artículos (para nombrar correctamente los inputs)
    let articleIndex = 1;

    // Función para actualizar costo y precio de un artículo en una fila determinada
    function updateArticleCosts(row) {
      // Obtenemos la opción seleccionada y sus datos
      const selectedOption = row.find('.articulo-select option:selected');
      const costoUnitario = parseFloat(selectedOption.data('costo')) || 0;
      const precioUnitario = parseFloat(selectedOption.data('valor')) || 0;
      const cantidad = parseInt(row.find('.cantidad-input').val()) || 0;
      const costo = costoUnitario * cantidad;
      const precio = precioUnitario * cantidad;
      row.find('.costo-total-articulo').val(costo.toFixed(2));
      row.find('.precio-total-articulo').val(precio.toFixed(2));
    }

    // Función para actualizar los totales del pedido
    function updateTotals() {
      let totalCosto = 0;
      let totalPrecio = 0;
      $('.article-row').each(function() {
        totalCosto += parseFloat($(this).find('.costo-total-articulo').val()) || 0;
        totalPrecio += parseFloat($(this).find('.precio-total-articulo').val()) || 0;
      });
      $('#totalCostoPedido').val(totalCosto.toFixed(2));
      // Solo se actualiza el precio total si no se está editando manualmente
      if (!$('#manualTogglePrecio').is(':checked')) {
        $('#totalPrecioPedido').val(totalPrecio.toFixed(2));
      }
    }

    $(document).ready(function() {
      // Inicializamos los totales en la fila por defecto
      updateArticleCosts($('.article-row'));
      updateTotals();
      
      // Al cambiar el artículo seleccionado o la cantidad, se recalculan los totales de la fila y del pedido
      $('#articulos-container').on('change', '.articulo-select, .cantidad-input', function() {
        const row = $(this).closest('.article-row');
        updateArticleCosts(row);
        updateTotals();
      });

      // Agregar nueva fila de artículo
      $('#add-article').click(function() {
    const newRow = $('.article-row').first().clone();

    // Actualizamos los nombres de los inputs para que sean únicos
    newRow.find('select, input').each(function() {
        const name = $(this).attr('name');
        if (name) {
            const newName = name.replace(/\[\d+\]/, '[' + articleIndex + ']');
            $(this).attr('name', newName);
        }
    });

    // Reiniciamos los valores de cantidad y costo
    newRow.find('.cantidad-input').val(1);
    newRow.find('.costo-total-articulo').val('0.00');
    newRow.find('.precio-total-articulo').val('0.00');

    // Habilitamos el botón de eliminar en la nueva fila
    newRow.find('.remove-article').prop('disabled', false);

    // Añadimos la nueva fila al contenedor
    $('#articulos-container').append(newRow);

    // Disparar manualmente el evento change en el select para actualizar los valores
    newRow.find('.articulo-select').trigger('change');

    articleIndex++;
    updateTotals();
});


      // Eliminar una fila de artículo (sólo si hay más de una)
      $('#articulos-container').on('click', '.remove-article', function() {
        if ($('#articulos-container .article-row').length > 1) {
          $(this).closest('.article-row').remove();
          updateTotals();
        }
      });
    });
  </script>
{% endblock %}
